{% block header_wrapper %}
<header class="navbar navbar-static-top masthead">
  <div class="container">

    <!-- ðŸ”¹ Baris Atas: Logo + Toggle + User (desktop) -->
    <div class="header-top d-flex justify-content-between align-items-center">
      
      <!-- Logo -->
      <hgroup class="{{ g.header_class }} m-0">
        {% if g.site_logo %}
          <a class="logo d-flex align-items-center" href="{{ h.url_for('home.index') }}">
            <img src="{{ h.url_for_static_or_external(g.site_logo) }}" alt="{{ g.site_title }}" />
          </a>
        {% else %}
          <h1 class="m-0"><a href="{{ h.url_for('home.index') }}">{{ g.site_title }}</a></h1>
        {% endif %}
      </hgroup>

      <!-- ðŸ”¹ Tombol Toggle (mobile) -->
      <button data-target="#main-navigation-toggle" data-toggle="collapse" 
              class="navbar-toggle collapsed d-lg-none ml-auto" type="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="fa fa-bars" style="color:#fff;"></span>
      </button>

      <!-- ðŸ”¹ User Menu (Desktop Only) -->
      <div class="navbar-right d-none d-lg-flex align-items-center">
        {% if c.userobj %}
          <div class="dropdown">
            <a href="#" class="dropdown-toggle d-flex align-items-center text-white" data-toggle="dropdown">
              {{ h.user_image((c.user if c and c.user else ''), size=28) }}
              <span class="username ml-2">{{ c.userobj.display_name }}</span>
              <b class="caret ml-1"></b>
            </a>
            <ul class="dropdown-menu dropdown-menu-right">
              <li><a href="{{ h.url_for('user.read', id=c.userobj.name) }}"><i class="fa fa-user"></i> Profil Saya</a></li>
              <li><a href="{{ h.url_for('dashboard.index') }}"><i class="fa fa-tachometer"></i> Dashboard</a></li>
              <li><a href="{{ h.url_for('user.edit', id=c.userobj.name) }}"><i class="fa fa-cog"></i> Pengaturan</a></li>
              {% if c.userobj.sysadmin %}
              <li class="divider"></li>
              <li><a href="{{ h.url_for(controller='admin', action='index') }}"><i class="fa fa-gavel"></i> Sysadmin</a></li>
              {% endif %}
              <li class="divider"></li>
              <li><a href="{{ h.url_for('/user/_logout') }}"><i class="fa fa-sign-out"></i> Keluar</a></li>
            </ul>
          </div>
        {% else %}
          <a href="{{ h.url_for('user.login') }}" class="btn btn-sm btn-outline-light ml-2">
            <i class="fa fa-sign-in"></i> Login
          </a>
        {% endif %}
      </div>
    </div>

    <!-- ðŸ”¹ Navigasi (berisi juga user menu di mobile) -->
    <div class="collapse navbar-collapse mt-2" id="main-navigation-toggle">
      <nav class="section navigation">
        <ul class="nav nav-pills">
          {{ h.build_nav_main(
            ('dataset.search', _('Dataset')),
            ('organization.index', _('OPD')),
            ('group.index', _('Kategori')),
            ('home.about', _('Tentang'))
          ) }}

          <!-- ðŸ”¹ Pembatas Navigasi vs User -->
          <li class="nav-divider d-lg-none"></li>

          <!-- ðŸ”¹ User Dropdown (Mobile Only) -->
          {% if c.userobj %}
            <li class="dropdown d-lg-none">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                <i class="fa fa-user-circle"></i> {{ c.userobj.display_name }} <b class="caret"></b>
              </a>
              <ul class="dropdown-menu">
                <li><a href="{{ h.url_for('user.read', id=c.userobj.name) }}"><i class="fa fa-user"></i> Profil Saya</a></li>
                <li><a href="{{ h.url_for('dashboard.index') }}"><i class="fa fa-tachometer"></i> Dashboard</a></li>
                <li><a href="{{ h.url_for('user.edit', id=c.userobj.name) }}"><i class="fa fa-cog"></i> Pengaturan</a></li>
                {% if c.userobj.sysadmin %}
                <li class="divider"></li>
                <li><a href="{{ h.url_for(controller='admin', action='index') }}"><i class="fa fa-gavel"></i> Sysadmin</a></li>
                {% endif %}
                <li class="divider"></li>
                <li><a href="{{ h.url_for('/user/_logout') }}"><i class="fa fa-sign-out"></i> Keluar</a></li>
              </ul>
            </li>
          {% else %}
            <li class="user-login d-lg-none">{% link_for _('Login'), named_route='user.login' %}</li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>
</header>

<!-- ðŸ”¹ Inline CSS + JS -->
<style>
  header.masthead {
    position: fixed;
    top: 0; left: 0; width: 100%;
    z-index: 1030;
    transition: all 0.3s ease;
    padding: 8px 0;
    background: #535353;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  body { padding-top: 70px; }

  header.masthead.scrolled {
    background: #3c3c3c;
    padding: 5px 0;
    box-shadow: 0 3px 12px rgba(0,0,0,0.3);
  }
  header.masthead img {
    max-height: 40px;
    transition: max-height 0.3s ease;
  }
  header.masthead.scrolled img { max-height: 32px; }

  /* Username */
  .navbar-right .username { font-weight: 500; margin-left: 6px; color: #fff; }

  /* Links */
  .navbar-right a { color: #f5f5f5; transition: color 0.2s; }
  .navbar-right a:hover { color: #ffd966; }

  /* Divider */
  .nav-divider {
    width: 100%;
    height: 1px;
    margin: 6px 0;
    background: rgba(255,255,255,0.2);
    list-style: none;
  }

  /* User Menu Highlight */
  .nav > li.user-login > a,
  .nav > li.dropdown > a {
    font-weight: 600;
    color: #ffd966 !important;
  }
  .nav > li.dropdown > a:hover,
  .nav > li.user-login > a:hover {
    color: #fff !important;
    background: rgba(255,255,255,0.1);
  }

  /* Dropdown style */
  .dropdown-menu {
    background: #444;
    border-radius: 6px;
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  }
  .dropdown-menu > li > a {
    color: #f5f5f5 !important;
  }
  .dropdown-menu > li > a:hover {
    background: #535353 !important;
    color: #ffd966 !important;
  }
</style>

<script>
  window.addEventListener("scroll", function() {
    var header = document.querySelector("header.masthead");
    if (header) {
      header.classList.toggle("scrolled", window.scrollY > 50);
    }
  });
</script>
{% endblock %}
